<!-- Generated by SpecStory -->

# 优化Pod状态展示格式 (2025-05-17 18:29:16)

_**User**_

很好了现在的效果，但是我有个好想法，我们是不是可以将下面详情表格展示也复用成格子形式展示，就像资源使用概览一样。你现在先要做的是，将前面格子中显示过的cpu 内存  磁盘 ，在下面详情中先删除；然后我们先从pod运行状态开始实验，首先pod运行状态，然后增加优雅美观的小标题(取namespace)，紧接着下面复用格子展示，格子内容展示pod运行状态（颜色方面，phase如果为Running和Succeeded则为绿色，Pending则为黄色，Failed为红色，Unknown为灰色），然后鼠标悬停时，仿照之前的资源使用概览格子的效果和格式展示pod名称和运行状态

---

_**Assistant**_



---

我需要先了解项目结构和相关代码，这样才能帮您实现这个效果。

---

<details>
            <summary>Listed current directory • **21** results</summary>
        
| Name |
|-------|
| 📁 `reports` |
| 📄 `stellar-autops` |
| 📄 `main.go` |
| 📁 `.specstory` |
| 📁 `.git` |
| 📁 `pkg` |
| 📄 `.goreleaser.yaml` |
| 📄 `Dockerfile` |
| 📄 `go.mod` |
| 📁 `tmp` |
| 📄 `.gitignore` |
| 📄 `README.md` |
| 📁 `config` |
| 📁 `templates` |
| 📁 `outputs` |
| 📁 `images` |
| 📁 `deploy` |
| 📄 `go.sum` |
| 📄 `.DS_Store` |
| 📁 `.github` |
| 📁 `.idea` |

</details>

---

让我看看模板目录中的代码，这里可能包含前端展示相关的文件：

---

<details>
            <summary>Listed directory templates • **2** results</summary>
        
| Name |
|-------|
| 📄 `report.html` |
| 📄 `status.html` |

</details>

---

我们需要先查看status.html文件，看看当前的Pod运行状态是如何展示的：

---

Read file: templates/status.html

---

让我继续查看该文件的后续内容:

---

Read file: templates/status.html

---

现在我需要查看report.html文件，特别是资源使用概览的格子形式展示部分：

---

Read file: templates/report.html

---

让我继续查看report.html文件的后半部分，特别是资源使用概览的格子形式实现：

---

Read file: templates/report.html

---

让我继续查看report.html中剩余的部分：

---

Read file: templates/report.html

---

现在，我已经了解了现有代码的结构和实现方式。我需要创建一个类似资源使用概览的格子展示方式，但用于Pod运行状态。下面我将修改report.html文件：

---

```diff
              }
          }
+ 
+         /* Pod状态格子样式 */
+         .pod-status-section {
+             margin-bottom: 30px;
+         }
+ 
+         .namespace-section {
+             margin-bottom: 20px;
+         }
+ 
+         .namespace-title {
+             font-size: 16px;
+             margin-bottom: 10px;
+             color: #333;
+             padding-left: 5px;
+             border-left: 4px solid #4CAF50;
+         }
+ 
+         .pod-grid {
+             display: flex;
+             flex-wrap: wrap;
+             gap: 4px;
+             margin-bottom: 15px;
+             align-items: center;
+         }
+ 
+         .pod-cell {
+             width: 30px;
+             height: 30px;
+             border-radius: 3px;
+             cursor: pointer;
+             position: relative;
+             display: flex;
+             align-items: center;
+             justify-content: center;
+             font-size: 10px;
+             color: white;
+             font-weight: bold;
+         }
+ 
+         .pod-cell.running {
+             background-color: #4CAF50; /* 绿色表示Running */
+         }
+ 
+         .pod-cell.succeeded {
+             background-color: #4CAF50; /* 绿色表示Succeeded */
+         }
+ 
+         .pod-cell.pending {
+             background-color: #ffc107; /* 黄色表示Pending */
+             color: #333;
+         }
+ 
+         .pod-cell.failed {
+             background-color: #dc3545; /* 红色表示Failed */
+         }
+ 
+         .pod-cell.unknown {
+             background-color: #6c757d; /* 灰色表示Unknown */
+         }
+ 
+         .pod-count {
+             margin-left: 20px;
+             font-weight: bold;
+             font-size: 14px;
+         }
+ 
+         .pod-status-legend {
+             display: flex;
+             margin: 10px 0 20px 0;
+             font-size: 12px;
+             flex-wrap: wrap;
+         }
+ 
+         .pod-status-legend .legend-color {
+             width: 16px;
+             height: 16px;
+             border-radius: 3px;
+             margin-right: 5px;
+         }
+ 
+         .pod-status-legend .legend-color.running,
+         .pod-status-legend .legend-color.succeeded {
+             background-color: #4CAF50;
+         }
+ 
+         .pod-status-legend .legend-color.pending {
+             background-color: #ffc107;
+         }
+ 
+         .pod-status-legend .legend-color.failed {
+             background-color: #dc3545;
+         }
+ 
+         .pod-status-legend .legend-color.unknown {
+             background-color: #6c757d;
+         }
+ 
+         .pod-cell:hover .tooltip {
+             visibility: visible;
+             opacity: 1;
+         }
      </style>
  </head>
```

```diff
              <h2>{{$type}} 监控指标</h2>
              {{range $metricName, $metrics := $group.MetricsByName}}
-                 {{if ne $metricName "系统运行时间"}}
+                 {{if ne $metricName "系统运行时间" }}
+                 {{if ne $metricName "CPU使用率" }}
+                 {{if ne $metricName "内存使用率" }}
+                 {{if ne $metricName "磁盘使用率" }}
+                 {{if ne $metricName "根分区磁盘使用率" }}
                  <h3><li>{{$metricName}}</li></h3>
                  {{if eq (len $metrics) 0 }}
                      <p>未查询到数据</p>
                  {{else}}
+                     <!-- Pod运行状态检查 -->
+                     {{if eq $metricName "Pod运行状态"}}
+                     <div class="pod-status-section">
+                         <!-- Pod运行状态格子图按命名空间分组 -->
+                         {{$namespaceGroups := (groupPodsByNamespace $metrics)}}
+                         {{range $namespace, $podMetrics := $namespaceGroups}}
+                         <div class="namespace-section">
+                             <h4 class="namespace-title">命名空间: {{$namespace}}</h4>
+                             <div class="pod-grid">
+                                 {{range $podMetric := $podMetrics}}
+                                     <div class="pod-cell {{getPodStatusClass $podMetric.Status}}">
+                                         <div class="tooltip">
+                                             <div class="tooltip-row">
+                                                 <span class="tooltip-label">Pod名称:</span>
+                                                 <span class="tooltip-value">{{getPodName $podMetric.Labels}}</span>
+                                             </div>
+                                             <div class="tooltip-row">
+                                                 <span class="tooltip-label">状态:</span>
+                                                 <span class="tooltip-value">{{$podMetric.Status}}</span>
+                                             </div>
+                                             <div class="tooltip-row">
+                                                 <span class="tooltip-label">检测时间:</span>
+                                                 <span class="tooltip-value">{{$podMetric.Timestamp.Format "2006-01-02 15:04:05"}}</span>
+                                             </div>
+                                         </div>
+                                     </div>
+                                 {{end}}
+                                 <div class="pod-count">总计: {{len $podMetrics}}个Pod</div>
+                             </div>
+                         </div>
+                         {{end}}
+                         
+                         <!-- Pod状态图例 -->
+                         <div class="pod-status-legend">
+                             <div class="legend-item">
+                                 <div class="legend-color running"></div>
+                                 <div>Running</div>
+                             </div>
+                             <div class="legend-item">
+                                 <div class="legend-color succeeded"></div>
+                                 <div>Succeeded</div>
+                             </div>
+                             <div class="legend-item">
+                                 <div class="legend-color pending"></div>
+                                 <div>Pending</div>
+                             </div>
+                             <div class="legend-item">
+                                 <div class="legend-color failed"></div>
+                                 <div>Failed</div>
+                             </div>
+                             <div class="legend-item">
+                                 <div class="legend-color unknown"></div>
+                                 <div>Unknown</div>
+                             </div>
+                         </div>
+                     </div>
+                     {{else}}
+                     <!-- 其他指标继续使用表格展示 -->
                      <table>
                          <tr>
```

```diff
                          {{end}}
                      </table>
+                     {{end}}
+                 {{end}}
+                 {{end}}
+                 {{end}}
+                 {{end}}
                  {{end}}
                  {{end}}
```

```diff
      });
  </script>
+ 
+ <script>
+     // Pod相关的辅助函数
+     function groupPodsByNamespace(podMetrics) {
+         const namespaceGroups = {};
+         
+         for (const metric of podMetrics) {
+             // 查找namespace标签
+             const namespaceLabel = metric.Labels.find(label => label.Name === "namespace");
+             const namespace = namespaceLabel ? namespaceLabel.Value : "default";
+             
+             if (!namespaceGroups[namespace]) {
+                 namespaceGroups[namespace] = [];
+             }
+             
+             namespaceGroups[namespace].push(metric);
+         }
+         
+         return namespaceGroups;
+     }
+     
+     function getPodName(labels) {
+         const podLabel = labels.find(label => label.Name === "pod");
+         return podLabel ? podLabel.Value : "未知";
+     }
+     
+     function getPodStatusClass(status) {
+         if (status === "Running" || status === "running") return "running";
+         if (status === "Succeeded" || status === "succeeded") return "succeeded";
+         if (status === "Pending" || status === "pending") return "pending";
+         if (status === "Failed" || status === "failed") return "failed";
+         return "unknown";
+     }
+ </script>
  </body>
  </html>
```

---

现在我们需要完善代码，确保Go语言的模板函数能够正确运行。由于我们在模板中使用了`groupPodsByNamespace`、`getPodName`和`getPodStatusClass`这些函数，需要在Go代码中实现这些函数。

让我们先查找相关的Go文件：

---

<details>
            <summary>Listed directory pkg • **8** results</summary>
        
| Name |
|-------|
| 📁 `stellar` |
| 📁 `config` |
| 📁 `metrics` |
| 📁 `notify` |
| 📁 `prometheus` |
| 📁 `report` |
| 📁 `status` |
| 📁 `utils` |

</details>

---

我们需要查看与report有关的Go文件，以便添加我们需要的模板函数：

---

<details>
            <summary>Listed directory pkg/report • **2** results</summary>
        
| Name |
|-------|
| 📄 `cleanup.go` |
| 📄 `generator.go` |

</details>

---

让我们查看generator.go文件，这个文件应该包含了HTML报告生成的相关代码：

---

Read file: pkg/report/generator.go

---

现在，我需要修改generator.go文件，添加我们需要的函数：

---

```diff
  	"os"
  	"sort"
+ 	"strings"
  	"time"
  )
```

```diff
  
  	// 生成报告
- 	tmpl, err := template.ParseFiles("templates/report.html")
+ 	// 创建模板函数映射
+ 	funcMap := template.FuncMap{
+ 		"now": time.Now,
+ 		"groupPodsByNamespace": func(metrics []MetricData) map[string][]MetricData {
+ 			return groupPodsByNamespace(metrics)
+ 		},
+ 		"getPodName": func(labels []LabelData) string {
+ 			return getPodName(labels)
+ 		},
+ 		"getPodStatusClass": func(status string) string {
+ 			return getPodStatusClass(status)
+ 		},
+ 	}
+ 
+ 	// 使用带函数映射的模板
+ 	tmpl, err := template.New("report.html").Funcs(funcMap).ParseFiles("templates/report.html")
  	if err != nil {
  		return "", fmt.Errorf("parsing template: %w", err)
```

```diff
  	return filename, nil // 添加返回语句
  }
+ 
+ // 按命名空间分组Pod指标
+ func groupPodsByNamespace(metrics []MetricData) map[string][]MetricData {
+ 	namespaceGroups := make(map[string][]MetricData)
+ 	
+ 	for _, metric := range metrics {
+ 		namespace := "default"
+ 		
+ 		// 查找namespace标签
+ 		for _, label := range metric.Labels {
+ 			if label.Name == "namespace" {
+ 				namespace = label.Value
+ 				break
+ 			}
+ 		}
+ 		
+ 		if _, exists := namespaceGroups[namespace]; !exists {
+ 			namespaceGroups[namespace] = []MetricData{}
+ 		}
+ 		
+ 		namespaceGroups[namespace] = append(namespaceGroups[namespace], metric)
+ 	}
+ 	
+ 	return namespaceGroups
+ }
+ 
+ // 从标签中获取Pod名称
+ func getPodName(labels []LabelData) string {
+ 	for _, label := range labels {
+ 		if label.Name == "pod" {
+ 			return label.Value
+ 		}
+ 	}
+ 	return "未知"
+ }
+ 
+ // 根据Pod状态获取CSS类名
+ func getPodStatusClass(status string) string {
+ 	status = strings.ToLower(status)
+ 	switch status {
+ 	case "running":
+ 		return "running"
+ 	case "succeeded":
+ 		return "succeeded"
+ 	case "pending":
+ 		return "pending"
+ 	case "failed":
+ 		return "failed"
+ 	default:
+ 		return "unknown"
+ 	}
+ }
  
```

---

让我们检查一下我们是否还需要修改其他文件。特别是，我们需要查看报告中Pod运行状态的数据是如何生成的。让我们查看main.go文件：

---

Read file: main.go

---

现在让我们检查一下metrics收集器，特别是与Pod状态相关的代码：

---

<details>
            <summary>Listed directory pkg/metrics • **1** results</summary>
        
| Name |
|-------|
| 📄 `collector.go` |

</details>

---

Read file: pkg/metrics/collector.go

---

我们现在需要检查配置文件，了解Pod状态指标是如何配置的：

---

<details>
            <summary>Listed directory config • **3** results</summary>
        
| Name |
|-------|
| 📄 `config.yaml` |
| 📄 `nginx.conf` |
| 📄 `config.yaml.bak` |

</details>

---

Read file: config/config.yaml

---

现在我们了解了代码的结构和Pod状态指标的配置方式。然而，我注意到集群Pod运行状态统计的查询只包含了Running状态的Pod。我们应该修改查询，以获取不同状态的Pod信息，这样才能在UI中根据状态显示不同颜色。

让我们修改配置文件：

---

```diff
        - name: "Pod运行状态"
          description: "集群Pod运行状态统计"
-         query: "sum by (namespace, pod) (kube_pod_status_phase{phase='Running'})"
+         query: "sum by (namespace, pod, phase) (kube_pod_status_phase)"
          #prometheus_url: "http://prometheus-k8s.kubesphere-monitoring-system:9090"
          prometheus_url: "http://172.31.101.239:13324/"
```

```diff
            namespace: "命名空间"
            pod: "Pod名称"
+           phase: "运行状态"
  
        - name: "节点就绪状态"
```

---

现在我们还需要修改Pod运行状态的处理方式，使其能够正确显示状态。让我们修改report.html中的Pod状态展示代码：

---

```diff
                              <div class="pod-grid">
                                  {{range $podMetric := $podMetrics}}
-                                     <div class="pod-cell {{getPodStatusClass $podMetric.Status}}">
+                                     <div class="pod-cell {{getPodStatusClass (getPodPhase $podMetric.Labels)}}">
                                          <div class="tooltip">
                                              <div class="tooltip-row">
                                                  <span class="tooltip-label">Pod名称:</span>
                                                  <span class="tooltip-value">{{getPodName $podMetric.Labels}}</span>
                                              </div>
+                                             <div class="tooltip-row">
+                                                 <span class="tooltip-label">命名空间:</span>
+                                                 <span class="tooltip-value">{{getNamespace $podMetric.Labels}}</span>
+                                             </div>
                                              <div class="tooltip-row">
                                                  <span class="tooltip-label">状态:</span>
-                                                 <span class="tooltip-value">{{$podMetric.Status}}</span>
+                                                 <span class="tooltip-value">{{getPodPhase $podMetric.Labels}}</span>
                                              </div>
                                              <div class="tooltip-row">
```

---

现在我们需要添加新的函数到generator.go文件中：

---

```diff
  			return getPodName(labels)
  		},
+ 		"getNamespace": func(labels []LabelData) string {
+ 			return getNamespace(labels)
+ 		},
  		"getPodStatusClass": func(status string) string {
  			return getPodStatusClass(status)
  		},
+ 		"getPodPhase": func(labels []LabelData) string {
+ 			return getPodPhase(labels)
+ 		},
  	}
  
```

```diff
  	}
  }
+ 
+ // 从标签中获取Pod阶段信息
+ func getPodPhase(labels []LabelData) string {
+ 	for _, label := range labels {
+ 		if label.Name == "phase" {
+ 			return label.Value
+ 		}
+ 	}
+ 	return "Unknown"
+ }
+ 
+ // 从标签中获取命名空间
+ func getNamespace(labels []LabelData) string {
+ 	for _, label := range labels {
+ 		if label.Name == "namespace" {
+ 			return label.Value
+ 		}
+ 	}
+ 	return "default"
+ }
  
```

---

要让浏览器正确加载我们更新的CSS样式，我们需要确保样式被正确包含在报告中：

---

```diff
              flex-wrap: wrap;
          }
+ 
+         .pod-status-legend .legend-item {
+             display: flex;
+             align-items: center;
+             margin-right: 20px;
+             margin-bottom: 5px;
+         }
  
          .pod-status-legend .legend-color {
```

---

确保JavaScript部分正确处理状态分类：

---

```diff
  	case "failed":
  		return "failed"
+ 	case "unknown", "":
+ 		return "unknown"
  	default:
  		return "unknown"
```

---

现在让我们再次检查JavaScript脚本部分，确保我们的函数可以正确地处理Pod分组：

---

```diff
  
  <script>
-     // Pod相关的辅助函数
+     // Pod相关的辅助函数 - 直接使用Go模板函数代替，不需要在JavaScript中再定义这些功能
+     // 但保留空的包装器函数，以防万一有地方使用了它们
      function groupPodsByNamespace(podMetrics) {
-         const namespaceGroups = {};
-         
-         for (const metric of podMetrics) {
-             // 查找namespace标签
-             const namespaceLabel = metric.Labels.find(label => label.Name === "namespace");
-             const namespace = namespaceLabel ? namespaceLabel.Value : "default";
-             
-             if (!namespaceGroups[namespace]) {
-                 namespaceGroups[namespace] = [];
-             }
-             
-             namespaceGroups[namespace].push(metric);
-         }
-         
-         return namespaceGroups;
+         console.log("此函数已被Go模板函数替代");
+         return {};
      }
      
      function getPodName(labels) {
-         const podLabel = labels.find(label => label.Name === "pod");
-         return podLabel ? podLabel.Value : "未知";
+         console.log("此函数已被Go模板函数替代");
+         return "";
      }
      
      function getPodStatusClass(status) {
-         if (status === "Running" || status === "running") return "running";
-         if (status === "Succeeded" || status === "succeeded") return "succeeded";
-         if (status === "Pending" || status === "pending") return "pending";
-         if (status === "Failed" || status === "failed") return "failed";
-         return "unknown";
+         console.log("此函数已被Go模板函数替代");
+         return "";
      }
  </script>
```

---

现在我们完成了所有必要的修改。下面是我们进行的修改的总结：

1. 修改了report.html文件，将Pod运行状态的展示从表格形式改为格子形式
2. 按namespace分组展示Pod状态
3. 根据Pod的状态设置不同的颜色：Running和Succeeded为绿色，Pending为黄色，Failed为红色，Unknown为灰色
4. 实现了鼠标悬停时显示pod名称、命名空间和运行状态的功能
5. 修改了配置文件中的Pod状态查询，以获取所有状态的Pod信息
6. 在Go代码中添加了支持模板函数，用于处理Pod状态数据
7. 从表格中删除了已经在格子中显示过的内容（CPU、内存、磁盘）

这些修改使得Pod运行状态的展示更加直观和美观，用户可以一目了然地看到各个命名空间中Pod的运行状态，并且能够通过鼠标悬停获取更详细的信息。

---

_**User**_

实际显示挺好的，但是有些重复了，kube_pod_status_phase只要值为1的，只有1的才为实际状态

---

