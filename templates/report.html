<!DOCTYPE html>
<html>
<head>
    <!--<title>集群系统监控巡检报告</title>-->
    <title>{{.Project}}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-item .label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        .stat-item .value {
            font-size: 1.2em;
            font-weight: bold;
        }
        .stat-item .value.alert {
            color: #dc3545;
        }
        .stat-item .value .critical {
            color: #dc3545;
            margin-right: 10px;
        }
        .stat-item .value .warning {
            color: #ffc107;
        }

        /* 表格样式 */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            table-layout: auto;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            min-width: 100px;
        }

        /* 指标名称列 */
        th:first-child, td:first-child {
            min-width: 150px;
        }

        /* 检测时间列 */
        th:last-child, td:last-child {
            min-width: 180px;
        }

        /* 状态列 */
        th:nth-last-child(2), td:nth-last-child(2) {
            min-width: 80px;
        }

        /* 值列 */
        th:nth-last-child(3), td:nth-last-child(3) {
            min-width: 100px;
        }

        th {
            background-color: #4CAF50;
            color: white;
        }

        /* 表格行状态样式 */
        tr.warning { 
            background-color: #fff3cd !important;
        }
        tr.normal { 
            background-color: #d4edda !important;
        }
        tr.critical { 
            background-color: #f8d7da !important;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .label-value {
            display: inline-block;
            background-color: #e9ecef;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            word-break: break-all;
            white-space: normal;
        }

        h1, h2, h3 {
            color: #333;
        }
        .section {
            margin-bottom: 30px;
        }
        .chart-container {
            height: 400px;
            margin-bottom: 30px;
        }

        /* 机器格子图样式 */
        .machine-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .machine-cell {
            width: 30px;
            height: 30px;
            border-radius: 3px;
            background-color: #4CAF50; /* 默认为绿色（正常） */
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
        }
        
        .machine-cell.offline {
            background-color: #d3d3d3; /* 灰色表示停机 */
            color: #333;
        }
        
        .machine-cell.warning {
            background-color: #ffc107; /* 黄色表示警告 */
            color: #333;
        }
        
        .machine-cell.critical {
            background-color: #dc3545; /* 红色表示严重 */
            color: white;
        }
        
        .machine-status-legend {
            display: flex;
            margin-bottom: 20px;
            font-size: 12px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 5px;
        }
        
        .legend-color.normal {
            background-color: #4CAF50;
        }
        
        .legend-color.warning {
            background-color: #ffc107;
        }
        
        .legend-color.critical {
            background-color: #dc3545;
        }
        
        .legend-color.offline {
            background-color: #d3d3d3;
        }
        
        .tooltip {
            visibility: hidden;
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 12px;
            white-space: pre-line;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s;
            text-align: left;
            min-width: 180px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .machine-cell:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .tooltip-row {
            display: flex;
            margin-bottom: 5px;
        }
        
        .tooltip-label {
            font-weight: bold;
            width: 70px;
            color: #cccccc;
        }
        
        .tooltip-value {
            color: white;
        }
        
        .inline-status {
            display: inline-block;
            vertical-align: middle;
        }
        
        .machine-count {
            margin-left: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        /* 响应式支持 */
        @media screen and (max-width: 1200px) {
            .container {
                padding: 10px;
            }
            
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            td, th {
                white-space: nowrap;
            }
        }

        /* Pod状态格子样式 */
        .pod-status-section {
            margin-bottom: 30px;
        }

        .namespace-section {
            margin-bottom: 20px;
        }

        .namespace-title {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
            padding-left: 5px;
            border-left: 4px solid #4CAF50;
        }

        .pod-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 15px;
            align-items: center;
        }

        .pod-cell {
            width: 30px;
            height: 30px;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
        }

        .pod-cell.running {
            background-color: #4CAF50; /* 绿色表示Running */
        }

        .pod-cell.succeeded {
            background-color: #4CAF50; /* 绿色表示Succeeded */
        }

        .pod-cell.pending {
            background-color: #ffc107; /* 黄色表示Pending */
            color: #333;
        }

        .pod-cell.failed {
            background-color: #dc3545; /* 红色表示Failed */
        }

        .pod-cell.unknown {
            background-color: #6c757d; /* 灰色表示Unknown */
        }

        .pod-count {
            margin-left: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .pod-status-legend {
            display: flex;
            margin: 10px 0 20px 0;
            font-size: 12px;
            flex-wrap: wrap;
        }

        .pod-status-legend .legend-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
            margin-bottom: 5px;
        }

        .pod-status-legend .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 5px;
        }

        .pod-status-legend .legend-color.running,
        .pod-status-legend .legend-color.succeeded {
            background-color: #4CAF50;
        }

        .pod-status-legend .legend-color.pending {
            background-color: #ffc107;
        }

        .pod-status-legend .legend-color.failed {
            background-color: #dc3545;
        }

        .pod-status-legend .legend-color.unknown {
            background-color: #6c757d;
        }

        .pod-cell:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        /* 健康状态显示区域样式 */
        .health-cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
        }

        /* 节点健康状态样式 */
        .node-health-section {
            margin: 0;
            padding: 0;
            flex: 1;
            min-width: 300px;
        }

        /* Harbor健康状态样式 */
        .harbor-health-section {
            margin: 0;
            padding: 0;
            flex: 1;
            min-width: 300px;
        }

        /* 统一的健康状态样式 */
        .health-status {
            display: inline-flex;
            align-items: center;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .health-status.healthy {
            background-color: #d4edda;
            color: #155724;
        }

        .health-status.warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .health-status.critical {
            background-color: #f8d7da;
            color: #721c24;
        }

        .health-status-icon {
            font-size: 20px;
            margin-right: 10px;
        }

        .harbor-components {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .harbor-component {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: white;
            min-width: 180px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .harbor-component.healthy {
            border-left: 3px solid #4CAF50;
        }

        .harbor-component.unhealthy {
            border-left: 3px solid #dc3545;
        }

        .component-name {
            font-weight: bold;
            color: #333;
        }

        .component-status {
            color: #4CAF50;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            background-color: #f0fff4;
        }

        .harbor-component.unhealthy .component-status {
            color: #dc3545;
            background-color: #fff5f5;
        }

        .node-health-warning {
            font-size: 14px;
            color: #721c24;
            margin: 5px 0;
        }

        /* 资源使用率图例 */
        .resource-usage-legend {
            display: flex;
            margin-top: 10px;
            font-size: 12px;
            flex-wrap: wrap;
        }

        .resource-usage-legend .legend-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
            margin-bottom: 5px;
        }

        .resource-usage-legend .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 5px;
        }

        .resource-usage-legend .legend-color.normal {
            background-color: #d4edda;
        }

        .resource-usage-legend .legend-color.warning {
            background-color: #fff3cd;
        }

        .resource-usage-legend .legend-color.critical {
            background-color: #f8d7da;
        }

        /* 节点和资源使用率样式 */
        .dashboard-section {
            margin: 20px 0;
            padding: 0;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding: 8px 15px;
            background-color: #f5f5f5;
            border-left: 4px solid #4CAF50;
            border-radius: 0 4px 4px 0;
            display: flex;
            align-items: center;
        }

        .section-title-icon {
            margin-right: 8px;
            font-size: 18px;
        }

        .section-title.pods {
            border-left-color: #4a90e2;
        }

        .section-title.nodes {
            border-left-color: #28a745;
        }

        .section-title.resources {
            border-left-color: #ffc107;
        }

        .section-title.registry {
            border-left-color: #17a2b8;
        }

        .metrics-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 20px;
            text-align: center;
            min-width: 150px;
            flex: 1;
        }

        .metric-card.normal {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }

        .metric-card.warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .metric-card.critical {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
        }

        /* Harbor服务状态样式 */
        .harbor-status-card {
            background-color: #d4edda;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .harbor-status-icon {
            font-size: 20px;
            color: #155724;
            margin-right: 10px;
        }

        .harbor-status-text {
            font-size: 16px;
            font-weight: bold;
            color: #155724;
        }

        .components-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .component-card {
            background-color: #fff;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 180px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .component-name {
            font-weight: bold;
            color: #333;
        }

        .component-status {
            color: #4CAF50;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            background-color: #f0fff4;
        }

        .component-card.unhealthy {
            border-left-color: #dc3545;
        }

        .component-card.unhealthy .component-status {
            color: #dc3545;
            background-color: #fff5f5;
        }

        /* 资源图例样式 */
        .resource-legend {
            display: flex;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 5px;
        }

        .legend-color.normal {
            background-color: #d4edda;
        }

        .legend-color.warning {
            background-color: #fff3cd;
        }

        .legend-color.critical {
            background-color: #f8d7da;
        }

        /* 标题样式 */
        .overview-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
            padding: 10px 15px;
            background-color: #f0f8ff;
            border-left: 5px solid #4a90e2;
            border-radius: 0 5px 5px 0;
        }

        /* 层级标题样式 */
        .report-main-section {
            margin: 25px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            background-color: #fff;
        }

        .main-section-header {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            background-color: #4a90e2;
            padding: 12px 15px;
            display: flex;
            align-items: center;
        }

        .main-section-icon {
            margin-right: 10px;
            font-size: 20px;
        }

        .subsection {
            margin: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            overflow: hidden;
        }

        .subsection-header {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            background-color: #f0f0f0;
            padding: 10px 15px;
            border-left: 4px solid #4CAF50;
            display: flex;
            align-items: center;
        }

        .subsection-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .subsection-content {
            padding: 15px;
        }

        .subsection-header.nodes {
            border-left-color: #28a745;
        }

        .subsection-header.resources {
            border-left-color: #ffc107;
        }

        .subsection-header.registry {
            border-left-color: #17a2b8;
        }

        .subsection-header.pods {
            border-left-color: #4a90e2;
        }

        .machine-cell.normal, .legend-color.normal {
            background-color: #4CAF50;
            color: white;
        }
        .machine-cell.warning, .legend-color.warning {
            background-color: #ffc107;
            color: #333;
        }
        .machine-cell.critical, .legend-color.critical {
            background-color: #dc3545;
            color: white;
        }
        .machine-cell.offline, .legend-color.offline {
            background-color: #d3d3d3;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <!--<h1>集群系统监控巡检报告</h1>-->
        <h1 style="text-align: center">{{.Project}}</h1>
        <p>生成时间: {{.Timestamp.Format "2006-01-02 15:04:05"}}</p>

        <!-- 巡检概览卡片 - 替代原有的基础资源使用情况 -->
        <div class="report-main-section">
            <div class="main-section-header">
                <span class="main-section-icon">📋</span>
                <span>巡检概览</span>
            </div>
            
            <!-- 概览卡片 -->
            <div class="summary-cards">
                {{range $type, $group := .MetricGroups}}
                <div class="card {{$type}}">
                    <h3>{{$type}}</h3>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="label">最大值</div>
                            <div class="value">{{printf "%.2f" $group.Stats.MaxValue}}</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">最小值</div>
                            <div class="value">{{printf "%.2f" $group.Stats.MinValue}}</div>
                        </div>
                        <!-- <div class="stat-item">
                            <div class="label">平均值</div>
                            <div class="value">{{printf "%.2f" $group.Stats.Average}}</div>
                        </div> -->
                        <div class="stat-item">
                            <div class="label">告警数</div>
                            <div class="value {{if gt $group.Stats.AlertCount 0}}alert{{end}}">
                                {{$group.Stats.AlertCount}}/{{$group.Stats.TotalCount}}
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="label">告警详情</div>
                            <div class="value">
                                <span class="critical">严重:{{$group.Stats.CriticalCount}}</span>
                                <span class="warning">警告:{{$group.Stats.WarningCount}}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {{end}}
            </div>
        </div>

        <!-- 图表部分 -->
        <div class="section">
            <div class="section-title">
                <span class="section-title-icon">🖥️</span>
                <span>服务器硬件状态</span>
            </div>
            
            <div class="machine-grid" id="machineGrid">
                <!-- 这里会通过JavaScript动态填充格子 -->
            </div>
        </div>

        <!-- 容器化平台健康度区块，保留原有展示 -->
        {{with $group := index .MetricGroups "基础资源使用情况"}}
            {{with $metrics := index $group.MetricsByName "Pod运行状态"}}
                <div class="pod-status-section">
                    <div class="report-main-section">
                        <div class="main-section-header">
                            <span class="main-section-icon">🔍</span>
                            <span>容器化平台健康度</span>
                        </div>
                        <div class="subsection-content">
                            <!-- 节点健康状况 -->
                            <div class="dashboard-section">
                                <div class="section-title nodes">
                                    <span class="section-title-icon">✓</span>
                                    <span>节点健康状况</span>
                                </div>
                                <div class="metrics-container">
                                    <div class="metric-card">
                                        <div class="metric-value">{{$.NodeHealth.Ready}}/{{$.NodeHealth.Total}}</div>
                                        <div class="metric-label">节点就绪状态</div>
                                    </div>
                                </div>
                                {{if gt $.NodeHealth.NotReady 0}}
                                <div class="node-health-warning">
                                    <span class="critical">有 {{$.NodeHealth.NotReady}} 个节点未就绪</span>
                                </div>
                                {{end}}
                            </div>
                            <!-- 集群资源使用率 -->
                            <div class="dashboard-section">
                                <div class="section-title resources">
                                    <span class="section-title-icon">📊</span>
                                    <span>集群资源使用率</span>
                                </div>
                                <div class="metrics-container">
                                    <div class="metric-card {{if floatLessThanEqual $.NodeHealth.ClusterCPUUsage 60.0}}normal{{else if floatLessThanEqual $.NodeHealth.ClusterCPUUsage 80.0}}warning{{else}}critical{{end}}">
                                        <div class="metric-value">{{printf "%.2f" $.NodeHealth.ClusterCPUUsage}}%</div>
                                        <div class="metric-label">CPU使用率</div>
                                    </div>
                                    <div class="metric-card {{if floatLessThanEqual $.NodeHealth.ClusterMemoryUsage 70.0}}normal{{else if floatLessThanEqual $.NodeHealth.ClusterMemoryUsage 85.0}}warning{{else}}critical{{end}}">
                                        <div class="metric-value">{{printf "%.2f" $.NodeHealth.ClusterMemoryUsage}}%</div>
                                        <div class="metric-label">内存使用率</div>
                                    </div>
                                </div>
                                <div class="resource-legend">
                                    <div class="legend-item">
                                        <div class="legend-color normal"></div>
                                        <div>正常 (CPU≤60%, 内存≤70%)</div>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color warning"></div>
                                        <div>警告 (60%&lt;CPU≤80%, 70%&lt;内存≤85%)</div>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color critical"></div>
                                        <div>严重 (CPU&gt;80%, 内存&gt;85%)</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Harbor健康 -->
                            {{if $.HarborHealth}}
                            <div class="dashboard-section">
                                <div class="section-title registry">
                                    <span class="section-title-icon">🗃️</span>
                                    <span>容器镜像仓库</span>
                                </div>
                                <div class="harbor-status-card">
                                    <span class="harbor-status-icon">{{if eq $.HarborHealth.Status "healthy"}}✓{{else}}✗{{end}}</span>
                                    <span class="harbor-status-text">Harbor服务状态: {{$.HarborHealth.Status}}</span>
                                </div>
                                <div class="components-container">
                                    {{range $.HarborHealth.Components}}
                                    <div class="component-card {{.Status}}">
                                        <span class="component-name">{{.Name}}</span>
                                        <span class="component-status">{{.Status}}</span>
                                    </div>
                                    {{end}}
                                </div>
                            </div>
                            {{end}}
                            <!-- Pod运行状态 -->
                            <div class="dashboard-section">
                                <div class="section-title pods">
                                    <span class="section-title-icon">📦</span>
                                    <span>Pod运行状态</span>
                                </div>
                                {{$namespaceGroups := (groupPodsByNamespace $metrics)}}
                                {{range $namespace, $podMetrics := $namespaceGroups}}
                                <div class="namespace-section">
                                    <h4 class="namespace-title">命名空间: {{$namespace}}</h4>
                                    <div class="pod-grid">
                                        {{range $podMetric := $podMetrics}}
                                            <div class="pod-cell {{getPodStatusClass (getPodPhase $podMetric.Labels)}}">
                                                <div class="tooltip">
                                                    <div class="tooltip-row">
                                                        <span class="tooltip-label">Pod名称:</span>
                                                        <span class="tooltip-value">{{getPodName $podMetric.Labels}}</span>
                                                    </div>
                                                    <div class="tooltip-row">
                                                        <span class="tooltip-label">命名空间:</span>
                                                        <span class="tooltip-value">{{getNamespace $podMetric.Labels}}</span>
                                                    </div>
                                                    <div class="tooltip-row">
                                                        <span class="tooltip-label">状态:</span>
                                                        <span class="tooltip-value">{{getPodPhase $podMetric.Labels}}</span>
                                                    </div>
                                                    <div class="tooltip-row">
                                                        <span class="tooltip-label">检测时间:</span>
                                                        <span class="tooltip-value">{{$podMetric.Timestamp.Format "2006-01-02 15:04:05"}}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        {{end}}
                                        <div class="pod-count">总计: {{len $podMetrics}}个Pod</div>
                                    </div>
                                </div>
                                {{end}}
                                <div class="pod-status-legend">
                                    <div class="legend-item">
                                        <div class="legend-color running"></div>
                                        <div>Running</div>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color succeeded"></div>
                                        <div>Succeeded</div>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color pending"></div>
                                        <div>Pending</div>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color failed"></div>
                                        <div>Failed</div>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color unknown"></div>
                                        <div>Unknown</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {{end}}
        {{end}}

        <!-- 自定义指标项组展示区 -->
        {{with $customGroup := index .MetricGroups "自定义指标项组"}}
        <div class="section">
            <h2>自定义指标项组</h2>
            {{range $metricName, $metrics := $customGroup.MetricsByName}}
                <h3><li>{{$metricName}}</li></h3>
                {{if eq (len $metrics) 0 }}
                    <p>未查询到数据</p>
                {{else}}
                <table>
                    <tr>
                        <th>指标名称</th>
                        {{$headerLabels := (index $metrics 0).Labels}}
                        {{range $headerLabels}}
                            <th data-label-name="{{.Name}}">{{.Alias}}</th>
                        {{end}}
                        <th>值</th>
                        <th>状态</th>
                        <th>检测时间</th>
                    </tr>
                    {{range $metric := $metrics}}
                    <tr class="{{.Status}}">
                        <td>{{.Name}}</td>
                        {{range $headerLabels}}
                            {{$labelName := .Name}}
                            {{range $metricLabel := $metric.Labels}}
                                {{if eq $metricLabel.Name $labelName}}
                                    <td data-label-name="{{$labelName}}">
                                        <span class="label-value">{{$metricLabel.Value}}</span>
                                    </td>
                                {{end}}
                            {{end}}
                        {{end}}
                        <td>{{printf "%.2f" $metric.Value}}{{.Unit}}</td>
                        <td>
                            {{if eq .Status "normal"}}正常
                            {{else if eq .Status "warning"}}警告
                            {{else if eq .Status "critical"}}严重
                            {{else}}{{.Status}}
                            {{end}}
                        </td>
                        <td>{{.Timestamp.Format "2006-01-02 15:04:05"}}</td>
                    </tr>
                    {{end}}
                </table>
                {{end}}
            {{end}}
        </div>
        {{end}}
    </div>

<script>
    // 生成随机颜色
    function getRandomColor() {
        const hue = Math.random() * 360;
        return {
            background: `hsla(${hue}, 70%, 95%, 1)`,
            border: `hsla(${hue}, 70%, 70%, 1)`
        };
    }

    // 设置卡片样式
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.card');
        const cardCount = cards.length;
        
        // 根据卡片数量优化布局
        const container = document.querySelector('.summary-cards');
        if (cardCount <= 2) {
            container.style.gridTemplateColumns = `repeat(${cardCount}, 1fr)`;
        } else if (cardCount <= 4) {
            container.style.gridTemplateColumns = 'repeat(2, 1fr)';
        }

        // 为每个卡片设置随机颜色
        cards.forEach(card => {
            const colors = getRandomColor();
            card.style.backgroundColor = colors.background;
            card.style.borderLeft = `4px solid ${colors.border}`;
        });
    });
</script>

<script>
    // 将数据作为JavaScript变量嵌入页面
    var data = JSON.parse('{{toJSON .MetricGroups}}');

    // 获取system_uptime数据并渲染机器格子图
    document.addEventListener('DOMContentLoaded', function() {
        // 获取所有机器列表（根据已有指标中的ident标签汇总）
        function getAllMachines() {
            const allMachines = new Set();
            
            for (const [type, group] of Object.entries(data)) {
                if (group.MetricsByName) {
                    for (const [metricName, metrics] of Object.entries(group.MetricsByName)) {
                        for (const metric of metrics) {
                            // 寻找ident标签
                            const identLabel = metric.Labels.find(label => label.Name === "ident");
                            if (identLabel && identLabel.Value) {
                                allMachines.add(identLabel.Value);
                            }
                        }
                    }
                }
            }
            
            // 转换为数组并按IP地址排序（如果是IP地址的话）
            return Array.from(allMachines).sort((a, b) => {
                if (a.match(/^\d+\.\d+\.\d+\.\d+$/) && b.match(/^\d+\.\d+\.\d+\.\d+$/)) {
                    // 如果都是IP地址，按IP排序
                    const ipA = a.split('.').map(num => parseInt(num, 10));
                    const ipB = b.split('.').map(num => parseInt(num, 10));
                    
                    for (let i = 0; i < 4; i++) {
                        if (ipA[i] !== ipB[i]) {
                            return ipA[i] - ipB[i];
                        }
                    }
                    return 0;
                } else {
                    // 否则按字符串排序
                    return a.localeCompare(b);
                }
            });
        }
        
        // 获取机器的system_uptime
        function getMachineUptime(machineIdent) {
            let uptime = null;
            
            // 尝试从指标数据中找到对应机器的system_uptime信息
            for (const [type, group] of Object.entries(data)) {
                if (group.MetricsByName && group.MetricsByName['系统运行时间']) {
                    for (const metric of group.MetricsByName['系统运行时间']) {
                        const identLabel = metric.Labels.find(label => label.Name === "ident");
                        if (identLabel && identLabel.Value === machineIdent) {
                            uptime = metric.Value;
                            break;
                        }
                    }
                }
            }
            
            return uptime;
        }
        
        // 获取机器状态（normal, warning, critical）
        function getMachineStatus(machineIdent) {
            let cpuUsage = null;
            let memUsage = null;
            let diskUsage = null;
            
            // 获取CPU使用率
            for (const [type, group] of Object.entries(data)) {
                if (group.MetricsByName && group.MetricsByName['CPU使用率']) {
                    for (const metric of group.MetricsByName['CPU使用率']) {
                        const identLabel = metric.Labels.find(label => label.Name === "ident");
                        if (identLabel && identLabel.Value === machineIdent) {
                            cpuUsage = metric.Value;
                            break;
                        }
                    }
                }
            }
            
            // 获取内存使用率
            for (const [type, group] of Object.entries(data)) {
                if (group.MetricsByName && group.MetricsByName['内存使用率']) {
                    for (const metric of group.MetricsByName['内存使用率']) {
                        const identLabel = metric.Labels.find(label => label.Name === "ident");
                        if (identLabel && identLabel.Value === machineIdent) {
                            memUsage = metric.Value;
                            break;
                        }
                    }
                }
            }
            
            // 获取根分区使用率
            for (const [type, group] of Object.entries(data)) {
                if (group.MetricsByName && group.MetricsByName['磁盘使用率']) {
                    for (const metric of group.MetricsByName['磁盘使用率']) {
                        const identLabel = metric.Labels.find(label => label.Name === "ident");
                        const pathLabel = metric.Labels.find(label => (label.Name === "path" || label.Name === "mountpoint") && (label.Value === "/" || label.Value === "rootfs"));
                        if (identLabel && identLabel.Value === machineIdent && pathLabel) {
                            diskUsage = metric.Value;
                            break;
                        }
                    }
                }
                
                // 尝试使用"根分区磁盘使用率"指标
                if (diskUsage === null && group.MetricsByName && group.MetricsByName['根分区磁盘使用率']) {
                    for (const metric of group.MetricsByName['根分区磁盘使用率']) {
                        const identLabel = metric.Labels.find(label => label.Name === "ident");
                        if (identLabel && identLabel.Value === machineIdent) {
                            diskUsage = metric.Value;
                            break;
                        }
                    }
                }
            }
            
            // 根据CPU、内存和磁盘使用率判断状态
            if (cpuUsage === null && memUsage === null && diskUsage === null) {
                return 'offline';
            }
            
            // 如果CPU、内存或磁盘使用率大于90%，则为严重
            if ((cpuUsage !== null && cpuUsage > 90) || 
                (memUsage !== null && memUsage > 90) ||
                (diskUsage !== null && diskUsage > 90)) {
                return 'critical';
            }
            
            // 如果CPU、内存或磁盘使用率大于80%，则为警告
            if ((cpuUsage !== null && cpuUsage > 80) ||
                (memUsage !== null && memUsage > 80) ||
                (diskUsage !== null && diskUsage > 80)) {
                return 'warning';
            }
            
            return 'normal';
        }
        
        // 格式化uptime显示
        function formatUptime(seconds) {
            if (seconds === null) return "未知";
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            let result = "";
            if (days > 0) result += `${days}天`;
            if (hours > 0 || days > 0) result += `${hours}小时`;
            result += `${minutes}分钟`;
            
            return result;
        }
        
        // 渲染机器格子图
        function renderMachineGrid() {
            const gridContainer = document.getElementById('machineGrid');
            if (!gridContainer) return;
            
            const machines = getAllMachines();
            let machineCount = 0;
            
            for (const machine of machines) {
                machineCount++;
                const status = getMachineStatus(machine);
                const isOnline = status !== 'offline';
                const uptime = getMachineUptime(machine);
                
                const cell = document.createElement('div');
                cell.className = `machine-cell ${status}`;
                
                // 不显示任何文本
                cell.textContent = '';
                
                // 获取CPU和内存使用率用于显示
                let cpuUsage = null;
                let memUsage = null;
                let diskUsage = null;
                
                for (const [type, group] of Object.entries(data)) {
                    if (group.MetricsByName) {
                        if (group.MetricsByName['CPU使用率']) {
                            for (const metric of group.MetricsByName['CPU使用率']) {
                                const identLabel = metric.Labels.find(label => label.Name === "ident");
                                if (identLabel && identLabel.Value === machine) {
                                    cpuUsage = metric.Value;
                                    break;
                                }
                            }
                        }
                        
                        if (group.MetricsByName['内存使用率']) {
                            for (const metric of group.MetricsByName['内存使用率']) {
                                const identLabel = metric.Labels.find(label => label.Name === "ident");
                                if (identLabel && identLabel.Value === machine) {
                                    memUsage = metric.Value;
                                    break;
                                }
                            }
                        }
                        
                        if (group.MetricsByName['磁盘使用率']) {
                            for (const metric of group.MetricsByName['磁盘使用率']) {
                                const identLabel = metric.Labels.find(label => label.Name === "ident");
                                const pathLabel = metric.Labels.find(label => (label.Name === "path" || label.Name === "mountpoint") && (label.Value === "/" || label.Value === "rootfs"));
                                if (identLabel && identLabel.Value === machine && pathLabel) {
                                    diskUsage = metric.Value;
                                    break;
                                }
                            }
                        }
                        
                        // 尝试使用"根分区磁盘使用率"指标
                        if (diskUsage === null && group.MetricsByName && group.MetricsByName['根分区磁盘使用率']) {
                            for (const metric of group.MetricsByName['根分区磁盘使用率']) {
                                const identLabel = metric.Labels.find(label => label.Name === "ident");
                                if (identLabel && identLabel.Value === machine) {
                                    diskUsage = metric.Value;
                                    break;
                                }
                            }
                        }
                    }
                }
                
                // 创建tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.innerHTML = `
                    <div class="tooltip-row">
                        <span class="tooltip-label">主机:</span>
                        <span class="tooltip-value">${machine}</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">运行时间:</span>
                        <span class="tooltip-value">${uptime !== null ? formatUptime(uptime) : '未知'}</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">CPU:</span>
                        <span class="tooltip-value">${cpuUsage !== null ? cpuUsage.toFixed(2) + '%' : '未知'}</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">内存:</span>
                        <span class="tooltip-value">${memUsage !== null ? memUsage.toFixed(2) + '%' : '未知'}</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">根分区:</span>
                        <span class="tooltip-value">${diskUsage !== null ? diskUsage.toFixed(2) + '%' : '未知'}</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">状态:</span>
                        <span class="tooltip-value inline-status">${status === 'normal' ? '正常' : 
                              status === 'warning' ? '警告' : 
                              status === 'critical' ? '严重' : '离线'}</span>
                    </div>
                `;
                
                cell.appendChild(tooltip);
                gridContainer.appendChild(cell);
            }
            
            // 添加总计说明
            const totalInfo = document.createElement('div');
            totalInfo.className = 'machine-count';
            totalInfo.textContent = `总计: ${machineCount}台`;
            gridContainer.appendChild(totalInfo);
            
            // 创建图例
            const legendContainer = document.createElement('div');
            legendContainer.className = 'machine-status-legend';
            
            // 添加各种状态的图例
            const statuses = [
                { class: 'normal', text: '正常' },
                { class: 'warning', text: '警告 (CPU/内存/根分区 > 80%)' },
                { class: 'critical', text: '严重 (CPU/内存/根分区 > 90%)' },
                { class: 'offline', text: '离线' }
            ];
            
            statuses.forEach(status => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                
                const color = document.createElement('div');
                color.className = `legend-color ${status.class}`;
                
                const text = document.createElement('div');
                text.textContent = status.text;
                
                item.appendChild(color);
                item.appendChild(text);
                legendContainer.appendChild(item);
            });
            
            // 将图例添加到grid后面
            const section = gridContainer.parentNode;
            section.insertBefore(legendContainer, gridContainer.nextSibling);
        }
        
        // 执行渲染
        renderMachineGrid();
    });
</script>

<script>
    // Pod相关的辅助函数 - 直接使用Go模板函数代替，不需要在JavaScript中再定义这些功能
    // 但保留空的包装器函数，以防万一有地方使用了它们
    function groupPodsByNamespace(podMetrics) {
        console.log("此函数已被Go模板函数替代");
        return {};
    }
    
    function getPodName(labels) {
        console.log("此函数已被Go模板函数替代");
        return "";
    }
    
    function getPodStatusClass(status) {
        console.log("此函数已被Go模板函数替代");
        return "";
    }
</script>
</body>
</html>