worker_processes auto;
pid /tmp/nginx.pid;

events {
  worker_connections 3096;
  use epoll;
  multi_accept on;
}

http {
  client_body_temp_path /tmp/client_body_temp;
  proxy_temp_path /tmp/proxy_temp;
  fastcgi_temp_path /tmp/fastcgi_temp;
  uwsgi_temp_path /tmp/uwsgi_temp;
  scgi_temp_path /tmp/scgi_temp;
  tcp_nodelay on;

  # this is necessary for us to be able to disable request buffering in all cases
  proxy_http_version 1.1;

  upstream stellar {
    server "stellar-center:80";
  }

  # 定义两个 Prometheus 服务器的上游
  upstream prometheus-stellar {
    server "172.31.101.239:48877";
  }

  upstream prometheus-k8s {
    server "172.31.101.239:13324";
  }

  log_format timed_combined '[$time_local]:$remote_addr - '
    '"$request" $status $body_bytes_sent '
    '"$http_referer" "$http_user_agent" '
    '$request_time $upstream_response_time $pipe';

  access_log /dev/stdout timed_combined;

  map $http_x_forwarded_proto $x_forwarded_proto {
    default $http_x_forwarded_proto;
    ""      $scheme;
  }

  server {
    listen 30007;
    server_tokens off;
    # disable any limits to avoid HTTP 413 for large image uploads
    client_max_body_size 0;

    # Add extra headers
    add_header X-Frame-Options DENY;
    add_header Content-Security-Policy "frame-ancestors 'none'";

    # Prometheus-stellar 代理配置
    location /prometheus-stellar/ {
      proxy_pass http://prometheus-stellar/;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $x_forwarded_proto;
      
      # 确保API响应正确处理
      sub_filter_once off;
      sub_filter_types application/javascript application/json text/css text/html;
      sub_filter 'href="/' 'href="/prometheus-stellar/';
      sub_filter 'src="/' 'src="/prometheus-stellar/';
      
      proxy_buffering off;
      proxy_request_buffering off;
    }

    # Prometheus-k8s 代理配置
    location /prometheus-k8s/ {
      proxy_pass http://prometheus-k8s/;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $x_forwarded_proto;
      
      # 确保API响应正确处理
      sub_filter_once off;
      sub_filter_types application/javascript application/json text/css text/html;
      sub_filter 'href="/' 'href="/prometheus-k8s/';
      sub_filter 'src="/' 'src="/prometheus-k8s/';
      
      proxy_buffering off;
      proxy_request_buffering off;
    }

    # 为了调试添加的状态检查
    location /nginx-status {
      stub_status on;
      access_log off;
      allow 127.0.0.1;
      allow 172.31.0.0/16;
      deny all;
    }

    location / {
      proxy_pass http://stellar/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $x_forwarded_proto;

      proxy_buffering off;
      proxy_request_buffering off;
    }
  }
}