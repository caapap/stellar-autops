<!-- Generated by SpecStory -->

# Docker Multi-Architecture Manifest Issue (2025-05-16 11:52:39)

_**User**_

Run # 前期配置，允许Docker CLI操作多架构清单
  # 前期配置，允许Docker CLI操作多架构清单
  mkdir -p $HOME/.docker
  echo '{"experimental": "enabled"}' > $HOME/.docker/config.json
  # 获取版本号（保留v前缀）
  VERSION=${GITHUB_REF#refs/tags/v}
  # 创建版本化的多架构清单（使用完整tag，包含v前缀）
  docker manifest create swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION} \
    swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-amd64 \
    swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-arm64v8
  # 注解指定架构信息
  docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION} \
    swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-amd64 --os linux --arch amd64
  docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION} \
    swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-arm64v8 --os linux --arch arm64 --variant v8
  # 推送多架构清单
  docker manifest push swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}
  
  # 再次为latest标签创建多架构清单
  docker manifest create swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:latest \
    swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-amd64 \
    swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-arm64v8
  # 注解指定架构信息
  docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:latest \
    swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-amd64 --os linux --arch amd64
  docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:latest \
    swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-arm64v8 --os linux --arch arm64 --variant v8
  # 推送latest标签的多架构清单
  docker manifest push swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:latest 
  shell: /usr/bin/bash -e {0}
  env:
    GO_VERSION: 1.23.4
  
Get "https://swr.cn-east-3.myhuaweicloud.com/v2/caapap/stellar-autops/manifests/0.0.5-amd64": denied: You may not login yet
Error: Process completed with exit code 1.

---

_**Assistant**_

您好！看起来您在尝试创建和推送 Docker 多架构清单时遇到了权限问题。错误信息显示您可能尚未登录到华为云的镜像仓库。让我们来解决这个问题。

我将为您运行一个命令来检查 Docker 是否已登录到正确的镜像仓库，并确保您有权限进行操作。



---

```bash
docker info | grep 'Username' | cat
```

```
(gpt) root@iflytek239:/iflytek/dev/stellar-v2.2-dev/stellar-autops# docker info | grep 'Username' | cat
(gpt) root@iflytek239:/iflytek/dev/stellar-v2.2-dev/stellar-autops#
```

---

看起来 Docker 没有显示任何已登录的用户名，这表明您可能尚未登录到华为云的镜像仓库。让我们尝试登录到 `swr.cn-east-3.myhuaweicloud.com`。



---

```bash
docker login swr.cn-east-3.myhuaweicloud.com
```

---

您好！看起来您选择不运行 Docker 登录命令。请告诉我您希望接下来做什么？我可以尝试其他方法

---

_**User**_

根据这个报错，结合另一个仓库成功案例进行修改：name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
env:
  GO_VERSION: 1.22

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Setup Go Environment
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Login Huawei-Cloud SWR
        uses: docker/login-action@v2
        with:
          registry: swr.cn-east-3.myhuaweicloud.com
          username: ${{ secrets.HUAWEI_SWR_USERNAME }}
          password: ${{ secrets.HUAWEI_SWR_PASSWORD }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v3
        with:
          distribution: goreleaser
          version: '~> v1'
          args: release --rm-dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: 推送镜像到华为云 SWR
        run: |
          # 推送 AMD64 镜像
          docker push swr.cn-east-3.myhuaweicloud.com/caapap/stellar:${{ github.ref_name }}-amd64
          # 推送 ARM64 镜像
          docker push swr.cn-east-3.myhuaweicloud.com/caapap/stellar:${{ github.ref_name }}-arm64v8
          # 推送多架构镜像
          docker manifest push swr.cn-east-3.myhuaweicloud.com/caapap/stellar:${{ github.ref_name }}
          # 推送 latest 标签
          docker manifest push swr.cn-east-3.myhuaweicloud.com/caapap/stellar:latest@release.yml 

---

_**Assistant**_

您好！根据您提供的成功案例和当前的错误信息，我将对 `release.yml` 进行修改，以确保 Docker 登录和镜像推送过程正确无误。

我将更新 Go 版本，调整 GoReleaser 的参数，并简化 Docker 镜像推送步骤，确保与华为云 SWR 兼容。



---

```diff
    workflow_dispatch:
  env:
-   GO_VERSION: 1.23.4
+   GO_VERSION: 1.22
  
  jobs:
```

```diff
        
        - name: Login Huawei-Cloud SWR
-         uses: docker/login-action@v3
+         uses: docker/login-action@v2
          with:
            registry: swr.cn-east-3.myhuaweicloud.com
```

```diff
          uses: docker/setup-buildx-action@v3
  
-       - name: Extract Version
-         id: version
-         run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
- 
        - name: Run GoReleaser
-         uses: goreleaser/goreleaser-action@v4
+         uses: goreleaser/goreleaser-action@v3
          with:
            distribution: goreleaser
-           version: latest
-           args: release --clean
+           version: '~> v1'
+           args: release --rm-dist
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
-       # 创建并推送Docker多架构清单
-       - name: Create and Push Docker Manifest
+       - name: 推送镜像到华为云 SWR
          if: success() && startsWith(github.ref, 'refs/tags/v')
          run: |
-           # 前期配置，允许Docker CLI操作多架构清单
-           mkdir -p $HOME/.docker
-           echo '{"experimental": "enabled"}' > $HOME/.docker/config.json
-           # 获取版本号（保留v前缀）
-           VERSION=${GITHUB_REF#refs/tags/v}
-           # 创建版本化的多架构清单（使用完整tag，包含v前缀）
-           docker manifest create swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION} \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-amd64 \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-arm64v8
+           # 推送 AMD64 镜像
+           docker push swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-amd64
+           # 推送 ARM64 镜像
+           docker push swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-arm64v8
+           # 创建版本化的多架构清单
+           docker manifest create swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }} \
+             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-amd64 \
+             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-arm64v8
            # 注解指定架构信息
-           docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION} \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-amd64 --os linux --arch amd64
-           docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION} \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-arm64v8 --os linux --arch arm64 --variant v8
+           docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }} \
+             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-amd64 --os linux --arch amd64
+           docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }} \
+             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-arm64v8 --os linux --arch arm64 --variant v8
            # 推送多架构清单
-           docker manifest push swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}
+           docker manifest push swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}
            
            # 再次为latest标签创建多架构清单
            docker manifest create swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:latest \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-amd64 \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-arm64v8
+             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-amd64 \
+             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-arm64v8
            # 注解指定架构信息
            docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:latest \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-amd64 --os linux --arch amd64
+             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-amd64 --os linux --arch amd64
            docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:latest \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:${VERSION}-arm64v8 --os linux --arch arm64 --variant v8
+             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-arm64v8 --os linux --arch arm64 --variant v8
            # 推送latest标签的多架构清单
            docker manifest push swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:latest 
```

---

我已经对 `.github/workflows/release.yml` 文件进行了更新，基于您提供的成功案例。主要修改包括：

1. 将 Go 版本从 1.23.4 更新到 1.22。
2. 将 `docker/login-action` 版本从 v3 降级到 v2。
3. 更新了 `goreleaser-action` 到 v3 版本，并将参数从 `--clean` 改为 `--rm-dist`。
4. 简化了 Docker 镜像推送步骤，使用 `github.ref_name` 来获取版本号，确保与标签一致。
5. 移除了手动设置 Docker 实验性功能的步骤，因为最新的 Docker CLI 已默认支持 manifest 操作。

这些更改应该能解决您在推送镜像到华为云 SWR 时遇到的权限和版本兼容性问题。如果还有其他问题，请随时告诉我。

---

_**User**_

移除多架构功能

---

_**Assistant**_

您好！我将根据您的要求移除多架构功能相关的步骤，只保留基本的镜像推送功能。

 

---

```diff
            # 推送 ARM64 镜像
            docker push swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-arm64v8 
-           # 创建版本化的多架构清单
-           docker manifest create swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }} \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-amd64 \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-arm64v8
-           # 注解指定架构信息
-           docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }} \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-amd64 --os linux --arch amd64
-           docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }} \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-arm64v8 --os linux --arch arm64 --variant v8
-           # 推送多架构清单
-           docker manifest push swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}
-           
-           # 再次为latest标签创建多架构清单
-           docker manifest create swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:latest \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-amd64 \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-arm64v8
-           # 注解指定架构信息
-           docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:latest \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-amd64 --os linux --arch amd64
-           docker manifest annotate swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:latest \
-             swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:v${{ github.ref_name }}-arm64v8 --os linux --arch arm64 --variant v8
-           # 推送latest标签的多架构清单
-           docker manifest push swr.cn-east-3.myhuaweicloud.com/caapap/stellar-autops:latest 
```

---

我已经对 `.github/workflows/release.yml` 文件进行了更新，移除了与多架构清单创建和推送相关的所有步骤。现在，工作流程将只推送 AMD64 和 ARM64 架构的镜像，而不会创建或推送多架构清单。

如果您有其他需求或问题，请随时告诉我。

---

_**User**_

Run goreleaser/goreleaser-action@v3
  
Downloading https://github.com/goreleaser/goreleaser/releases/download/v1.26.2/goreleaser_Linux_x86_64.tar.gz
Extracting GoReleaser
/usr/bin/tar xz --warning=no-unknown-keyword --overwrite -C /home/runner/work/_temp/1dd3a4f5-37af-4a33-a030-5ced6499c873 -f /home/runner/work/_temp/7b867d09-9333-40f1-bd27-23ffc81b0f5d
GoReleaser ~> v1 installed successfully
v0.0.5 tag found for commit 'c368ad0'
/opt/hostedtoolcache/goreleaser-action/1.26.2/x64/goreleaser release --rm-dist
Flag --rm-dist has been deprecated, please use --clean instead
  • starting release...
  ⨯ release failed after 0s                  error=only configurations files on version: 1 are supported, yours is version: 2, please update your configuration
Error: The process '/opt/hostedtoolcache/goreleaser-action/1.26.2/x64/goreleaser' failed with exit code 1

---

_**Assistant**_

您好！看起来您遇到了 GoReleaser 版本兼容性问题。错误信息显示您当前的配置文件版本是 2，但使用的 GoReleaser 版本只支持版本 1 的配置文件。我们需要更新 GoReleaser 的版本以支持版本 2 的配置文件。

我将对 `.github/workflows/release.yml` 文件进行修改，更新 GoReleaser 的版本。

 

---

```diff
  
        - name: Run GoReleaser
-         uses: goreleaser/goreleaser-action@v3
+         uses: goreleaser/goreleaser-action@v5
          with:
            distribution: goreleaser
-           version: '~> v1'
-           args: release --rm-dist
+           version: latest
+           args: release --clean
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

我已经对 `.github/workflows/release.yml` 文件进行了更新，将 GoReleaser 版本从 v3 升级到 v5，并将版本设置为 `latest`，同时将参数从 `--rm-dist` 改为 `--clean`，以支持版本 2 的配置文件。

这些更改应该能解决您遇到的兼容性问题。如果还有其他问题，请随时告诉我。

---

_**User**_

Run goreleaser/goreleaser-action@v5
  
Warning: You are using 'latest' as default version. Will lock to '~> v1'.
Downloading https://github.com/goreleaser/goreleaser/releases/download/v1.26.2/goreleaser_Linux_x86_64.tar.gz
Extracting GoReleaser
/usr/bin/tar xz --warning=no-unknown-keyword --overwrite -C /home/runner/work/_temp/a514ce60-ddc1-464c-80de-4c1aac7285c8 -f /home/runner/work/_temp/d3ce37ab-4f12-46fc-95d2-1a5d96ee29f5
GoReleaser latest installed successfully
/opt/hostedtoolcache/goreleaser-action/1.26.2/x64/goreleaser release --clean
  • starting release...
  ⨯ release failed after 0s                  error=only configurations files on version: 1 are supported, yours is version: 2, please update your configuration
Error: The process '/opt/hostedtoolcache/goreleaser-action/1.26.2/x64/goreleaser' failed with exit code 1

---

_**Assistant**_

您好！看起来即使我们将 GoReleaser 版本更新到 v5，它仍然下载了 v1.26.2 版本的 GoReleaser，该版本不支持版本 2 的配置文件。错误信息显示我们需要使用支持版本 2 配置文件的 GoReleaser 版本。

让我们尝试指定一个特定的、支持版本 2 配置文件的 GoReleaser 版本。我将对 `.github/workflows/release.yml` 文件进行修改，明确指定 GoReleaser 的版本。

  

---

```diff
          with:
            distribution: goreleaser
-           version: latest
+           version: v2.0.0
            args: release --clean
          env:
```

---

我已经对 `.github/workflows/release.yml` 文件进行了更新，将 GoReleaser 的版本明确指定为 `v2.0.0`，以确保它支持版本 2 的配置文件。

这些更改应该能解决您遇到的兼容性问题。如果还有其他问题，请随时告诉我。

---

_**User**_

Run goreleaser/goreleaser-action@v5
  
Downloading https://github.com/goreleaser/goreleaser/releases/download/v2.0.0/goreleaser_Linux_x86_64.tar.gz
Extracting GoReleaser
/usr/bin/tar xz --warning=no-unknown-keyword --overwrite -C /home/runner/work/_temp/e2de8f96-d58b-4c0e-946a-129fd2d2e33e -f /home/runner/work/_temp/dc221c70-f388-4875-853c-0f4b9d0e01ed
GoReleaser v2.0.0 installed successfully
/opt/hostedtoolcache/goreleaser-action/2.0.0/x64/goreleaser release --clean
  • starting release...
  ⨯ release failed after 0s                  error=yaml: unmarshal errors:
  line 51: field formats not found in type config.Archive
  line 55: field formats not found in type config.FormatOverride
Error: The process '/opt/hostedtoolcache/goreleaser-action/2.0.0/x64/goreleaser' failed with exit code 1


---

_**Assistant**_

您好！看起来我们遇到了一个新的问题。GoReleaser v2.0.0 不支持您配置文件中的 `formats` 字段。我们需要更新 `.goreleaser.yaml` 文件以适应 GoReleaser v2.0.0 的配置格式。

我将对 `.goreleaser.yaml` 文件进行修改，移除或调整不支持的字段。

  

---

```diff
      name_template: "stellar-autops-v{{ .Version }}-{{ .Os }}-{{ .Arch }}"
      wrap_in_directory: false
-     formats:
-       - tar.gz
-     format_overrides:
-       - goos: windows
-         formats:
-           - zip
      files:
        - README.md
```

---

我已经对 `.goreleaser.yaml` 文件进行了更新，移除了不支持的 `formats` 和 `format_overrides` 字段，以适应 GoReleaser v2.0.0 的配置格式。

这些更改应该能解决您遇到的配置错误。如果还有其他问题，请随时告诉我。

---

_**User**_

@release.yml @.goreleaser.yaml Run goreleaser/goreleaser-action@v3
Downloading https://github.com/goreleaser/goreleaser/releases/download/v1.26.2/goreleaser_Linux_x86_64.tar.gz
Extracting GoReleaser
/usr/bin/tar xz --warning=no-unknown-keyword --overwrite -C /home/runner/work/_temp/0751025b-6ec1-44dc-a42e-c3359fea1aea -f /home/runner/work/_temp/6eae2b00-2396-4c4f-85ff-e6e125464341
GoReleaser ~> v1 installed successfully
v0.0.5 tag found for commit 'e9263a6'
/opt/hostedtoolcache/goreleaser-action/1.26.2/x64/goreleaser release --rm-dist
Flag --rm-dist has been deprecated, please use --clean instead
  • starting release...
  ⨯ release failed after 0s                  error=only configurations files on version: 1 are supported, yours is version: 2, please update your configuration
Error: The process '/opt/hostedtoolcache/goreleaser-action/1.26.2/x64/goreleaser' failed with exit code 1

---

_**Assistant**_



---

您好！看起来问题依然存在，我们需要调整 `.goreleaser.yaml` 文件的版本号，将其从版本 2 改为版本 1，以适应 GoReleaser v1.26.2 的要求。

让我为您修改 `.goreleaser.yaml` 文件：

 

---

```diff
- version: 2
+ version: 1
  
  before:
```

---

我已经将 `.goreleaser.yaml` 文件中的配置版本从 2 更改为 1，以符合 GoReleaser v1.26.2 的要求。这样应该可以解决错误 "only configurations files on version: 1 are supported, yours is version: 2"。

现在，您可以再次尝试运行工作流程，GoReleaser 应该能够成功识别并使用您的配置文件了。

---

_**User**_

Run goreleaser/goreleaser-action@v3
  
Downloading https://github.com/goreleaser/goreleaser/releases/download/v1.26.2/goreleaser_Linux_x86_64.tar.gz
Extracting GoReleaser
/usr/bin/tar xz --warning=no-unknown-keyword --overwrite -C /home/runner/work/_temp/e511eafc-00e6-488b-a104-c4a2dfde2a81 -f /home/runner/work/_temp/bdb01aeb-4521-4bb5-a9b9-c3a4659edbfd
GoReleaser ~> v1 installed successfully
v0.0.5 tag found for commit '96eee73'
/opt/hostedtoolcache/goreleaser-action/1.26.2/x64/goreleaser release --rm-dist
Flag --rm-dist has been deprecated, please use --clean instead
  • starting release...
  ⨯ release failed after 0s                  error=yaml: unmarshal errors:
  line 51: field formats not found in type config.Archive
  line 55: field formats not found in type config.FormatOverride
Error: The process '/opt/hostedtoolcache/goreleaser-action/1.26.2/x64/goreleaser' failed with exit code 1

---

_**Assistant**_



---

您好！我们需要继续调整 `.goreleaser.yaml` 文件，移除不兼容的 `formats` 和 `format_overrides` 字段。根据错误信息，GoReleaser v1.26.2 不支持这两个字段。

我将对 `.goreleaser.yaml` 文件进行修改：

 

---

```diff
      name_template: "stellar-autops-v{{ .Version }}-{{ .Os }}-{{ .Arch }}"
      wrap_in_directory: false
-     formats:
-       - tar.gz
-     format_overrides:
-       - goos: windows
-         formats:
-           - zip
      files:
        - README.md
```

---

我已经从 `.goreleaser.yaml` 文件中移除了不兼容的 `formats` 和 `format_overrides` 字段。这些字段在 GoReleaser v1.26.2 中不被支持。

现在，配置文件应该与 GoReleaser v1.26.2 兼容了。配置文件的版本设置为 1，并且移除了不兼容的字段。

请再次尝试运行工作流程，应该能够成功执行了。如果还有其他问题，请随时告诉我。

---

_**User**_

重构使用最新的goreleaser

---

_**Assistant**_



---

好的，我将重构工作流程配置，使用最新版本的 GoReleaser。让我们修改 `.github/workflows/release.yml` 文件：

 

---

```diff
      steps:
        - name: Checkout Source Code
-         uses: actions/checkout@v3
+         uses: actions/checkout@v4
          with:
            fetch-depth: 0
        
        - name: Setup Go Environment
-         uses: actions/setup-go@v3
+         uses: actions/setup-go@v5
          with:
            go-version: ${{ env.GO_VERSION }}
        
        - name: Login Huawei-Cloud SWR
-         uses: docker/login-action@v2
+         uses: docker/login-action@v3
          with:
            registry: swr.cn-east-3.myhuaweicloud.com
```

```diff
  
        - name: Run GoReleaser
-         uses: goreleaser/goreleaser-action@v3
+         uses: goreleaser/goreleaser-action@v5
          with:
            distribution: goreleaser
-           version: '~> v1'
-           args: release --rm-dist
+           version: latest
+           args: release --clean
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

现在，让我们也检查一下 `.goreleaser.yaml` 文件，确保它适用于最新版本的 GoReleaser：

 

---

```diff
- version: 1
+ version: 2
  
  before:
```

```diff
      name_template: "stellar-autops-v{{ .Version }}-{{ .Os }}-{{ .Arch }}"
      wrap_in_directory: false
-     formats:
-       - tar.gz
+     format: tar.gz
      format_overrides:
        - goos: windows
-         formats:
-           - zip
+         format: zip
      files:
        - README.md
```

---

我已经更新了配置文件。主要修改如下：

1. 在 `.github/workflows/release.yml` 文件中：
   - 更新 Checkout 操作从 v3 到 v4
   - 更新 Setup Go 操作从 v3 到 v5
   - 更新 Docker Login 操作从 v2 到 v3
   - 更新 GoReleaser 操作从 v3 到 v5
   - 更改参数从 `--rm-dist` 到 `--clean`
   - 指定 GoReleaser 版本为 `latest`

2. 在 `.goreleaser.yaml` 文件中：
   - 将版本恢复为 2
   - 将 `formats` 改为 `format`（单数形式）
   - 将 `formats` 下的数组改为单个值
   - 将 `format_overrides` 中的 `formats` 改为 `format`（单数形式）

这些修改应该使配置适用于最新版本的 GoReleaser。现在，工作流程应该能够成功执行了。如果还有其他问题，请随时告诉我。

---

